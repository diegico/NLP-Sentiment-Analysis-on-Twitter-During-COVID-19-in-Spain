---
title: "Guión"
author: "Grupo 1"
date: "2024-05-30"
output: 
  pdf_document:
    latex_engine: xelatex

---

################ TRABAJO FINAL ################
######### GRUPO 1 #########
##### 03/06/2024 #####



### Instalar paquetes necesarios para la realización de este proyecto
```{r}
#install.packages("readr")
#install.packages("tweetCoin")
#install.packages("netCoin")
#install.packages("tidyverse")
#install.packages("ggplot2")
#install.packages("textdata")
#install.packages("syuzhet")
#install.packages("RColorBrewer")
#install.packages("wordcloud")
#install.packages("tm")
#install.packages("textplot")

```


## Cargar librerias
```{r}
library(readr)
library(tweetCoin)
library(netCoin)
library(tidyverse)
library(ggplot2)
library(textdata)
library(tidytext)
library(syuzhet)
library(RColorBrewer)
library(wordcloud)
library(tm)
library(textplot)
library(stopwords)
library(gganimate)

```


# Datos utilizados para el trabajo
```{r}
covid_twt <- read_csv("covid19-tweets-early-late-april_lang_es_country_ES.csv")
```


# Leer el archivo CSV que contiene las palabras a excluir
```{r}
palabras_filtro <- read_csv("palabras_filtro.csv", 
                            locale = locale(encoding = "Latin1"))
excluir <- paste(palabras_filtro$paises, collapse = "|")
```


# Filtro para quitar variables irrelevantes
```{r}
covid_filtrado <- covid_twt %>% 
  select(c(screen_name, text, created_at, followers_count, place_full_name)) %>% 
  rename(author = screen_name,
         text = text,
         date = created_at,
         followers = followers_count,
         location = place_full_name) %>% 
  filter(!grepl(excluir, text, ignore.case = TRUE)) %>% 
  mutate(text = gsub("\n", " ", text)) %>% 
  distinct(text, .keep_all = TRUE)
```


## Redes de conspiraciones
## vacuna
```{r}
vacuna <- covid_filtrado %>% 
  filter(grepl("vacuna", text, ignore.case = TRUE))
head(vacuna$text)

c <- cotweet(vacuna, "text", min = 15)
c2 <- netCoin(c, size = "degree", distance = 11.18,
                     repulsion = 20.8, zoom = .7, color = "community", 
                     shape = "type", main= "Grafico Network")
#plot(c2)
```


#Análisis de sentimientos
```{r}

#Análisis de sentimientos


stopwords_es <- stopwords("es")
stopwords_adicionales <- read.csv("stopwords_adicionales.csv", stringsAsFactors = F)$alfabeto
stopwords_final <- c(stopwords_es, stopwords_adicionales)

# Limpiar el texto

```

# Limpiar el texto
```{r}

vacuna_clean <- vacuna %>%
  mutate(text = str_to_lower(text)) %>%
  mutate(text = str_replace_all(text, "(#\\w+|@\\w+|https\\S+)\\b", "")) %>% 
  mutate(text = str_replace_all(text, "[[:punct:]]", "")) %>%
  mutate(text = str_replace_all(text, "[[:digit:]]", "")) 

```


# Tokenizar el texto 
```{r}
vacuna_tokens <- vacuna_clean %>%
  unnest_tokens(word, text)
#filtrar
vacuna_tokens_filtered <- vacuna_tokens %>%
  filter(!word %in% stopwords_final)

vacuna_tokens_vector <- c(vacuna_tokens_filtered$word)

# Obtener la polaridad 

```


#filtrar
```{r}
vacuna_tokens_filtered <- vacuna_tokens %>%
  filter(!word %in% stopwords_final)

vacuna_tokens_vector <- c(vacuna_tokens_filtered$word)

```

# Obtener la polaridad 
```{r}

polaridad <-  get_nrc_sentiment(vacuna_tokens_vector, language = "spanish")

barplot(
  colSums(prop.table(polaridad[, 1:8])),
  space = 0.2,
  horiz = FALSE,
  las = 1,
  cex.names = 0.7,
  col = brewer.pal(n = 8, name = "Set3"),
  main = "Análisis de sentimientos",
  xlab="emociones", ylab = NULL, ylim = c(0, 0.2))

```


##nube
# Crear el vector de emociones
```{r}
nube_emociones_vector <- c(
  paste(vacuna_tokens_vector[polaridad$fear > 0], collapse = " "),
  paste(vacuna_tokens_vector[polaridad$sadness > 0], collapse = " "),
  paste(vacuna_tokens_vector[polaridad$trust > 0], collapse = " "),
  paste(vacuna_tokens_vector[polaridad$anticipation > 0], collapse = " ")
)
```


# Convertir la codificación
```{r}
nube_emociones_vector <- iconv(nube_emociones_vector, "latin1", "UTF-8")
```


# Crear el corpus
```{r}
nube_corpus <- Corpus(VectorSource(nube_emociones_vector))
```


# Función para eliminar hashtags
```{r}
removeHashtags <- content_transformer(function(x, pattern) gsub(pattern, "", x))
nube_corpus <- tm_map(nube_corpus, removeHashtags, "#\\S+")
```


# Limpiar el texto
```{r}
nube_corpus <- tm_map(nube_corpus, content_transformer(tolower))
nube_corpus <- tm_map(nube_corpus, removePunctuation)
nube_corpus <- tm_map(nube_corpus, removeNumbers)
nube_corpus <- tm_map(nube_corpus, removeWords, stopwords_final)
nube_corpus <- tm_map(nube_corpus, stripWhitespace)
```


# Crear la matriz de términos-documentos
```{r}
nube_tdm <- TermDocumentMatrix(nube_corpus)
nube_tdm <- as.matrix(nube_tdm)
colnames(nube_tdm) <- c('miedo', 'tristeza', 'confianza', 'anticipación')
```


# Generar la nube de comparación
```{r}
set.seed(600) # puede ser cualquier número
comparison.cloud(nube_tdm, random.order = FALSE,
                 colors = c("green", "red", "orange", "blue"), # Ajusta los colores según sea necesario
                 title.size = 1, max.words = 200, scale = c(2.5, 0.75),
                 min.freq=1, root.per=0.1)
legend("topright", legend = colnames(nube_tdm),  title = "Emociones")
```



## Análisis Serie temporal
```{r}
fecha <- as.Date(vacuna_tokens_filtered$date)
tendencia_df <- data.frame(fecha, polaridad)
tendencia <- tendencia_df %>% 
  select(fecha, fear, sadness,trust, anticipation)
```


# Agrupar los datos por fecha y calcular la media de "fear"
```{r}
data_agg <- tendencia %>%
  group_by(fecha) %>%
  summarise(mean_fear = mean(fear))
```


# Identificar máximos relativos
```{r}
find_local_maxima <- function(x) {
  return((x > lag(x, default = first(x))) & (x > lead(x, default = last(x))))
}

data_agg <- data_agg %>%
  mutate(is_maxima = find_local_maxima(mean_fear))
```


# Filtrar los puntos que son máximos relativos
```{r}
maxima_points <- data_agg %>%
  filter(is_maxima)
```


# Crear el gráfico de líneas con anotaciones para los máximos relativos
```{r}
ggplot(data_agg, aes(x = fecha, y = mean_fear)) +
  geom_line() +
  geom_point(data = maxima_points, aes(x = fecha, y = mean_fear), color = "red", size = 3) +
  geom_text(data = maxima_points, aes(x = fecha, y = mean_fear, label = fecha), vjust = -1, hjust = 1, color = "blue") +
  labs(title = "Media de Fear a lo largo del tiempo con Máximos Relativos",
       x = "Fecha",
       y = "Media de Fear") +
  theme_minimal() 



ggplot(tendencia, aes(fecha, fill=fear) ) +
  labs(title = "Presencia de miedo en tweets")+ylab("Grado de miedo") +
  theme(plot.title = element_text(size = rel(2), colour = "Black"))+
  geom_bar(position="dodge")

```

















